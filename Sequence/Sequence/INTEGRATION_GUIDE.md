# Dog DNA Mutation System - Integration Guide

## Overview
This system applies genetic mutations to dog DNA sequences based on user-selected traits from `trait_selection.py`.

## System Components

### 1. **Reference.json**
- Location: `Sequence/Reference.json`
- Contains all mutation definitions for dog coat color and trait alleles
- Mutation types supported:
  - `REF`: Reference allele (no mutation)
  - `SNP`: Single Nucleotide Polymorphism
  - `DEL`: Deletion
  - `INS`: Insertion

### 2. **Template FASTA Files**
- Location: `Sequence/extracted_genes/`
- Generated by: `read_sequence.py` (auto-runs when executed without arguments)
- Files:
  - `MC1R_template.fasta` - E locus (coat color extension)
  - `CBD103_template.fasta` - K locus (dominant black)
  - `ASIP_template.fasta` - A locus (agouti pattern)
  - `TYRP1_template.fasta` - B locus (brown/liver)
  - `MLPH_template.fasta` - D locus (dilution)
  - `MITF_template.fasta` - S locus (white spotting)
  - `FGF5_template.fasta` - L locus (coat length)

### 3. **Mutation Applier**
- File: `Sequence/genotype_to_sequence.py`
- Main class: `GenotypeToSequence`
- Converts genotype from trait_selection.py to mutated DNA sequences

## Usage

### From trait_selection.py

```python
from Sequence.genotype_to_sequence import GenotypeToSequence

# Initialize converter
converter = GenotypeToSequence(
    reference_json_path="Sequence/Reference.json",
    sequence_dir="Sequence/extracted_genes"
)

# Example genotype from trait_selection.py
# This comes from father_final or mother_final
genotype = {
    "E": ("E", "e"),      # Black carries red
    "K": ("Kb", "ky"),    # Dominant black carries agouti
    "A": ("Ay", "at"),    # Sable carries tan-point
    "B": ("B", "b"),      # Black carries brown
    "D": ("D", "D"),      # Full color
    "M": ("m", "m"),      # Non-merle
    "S": ("S", "S"),      # Solid coat
    "L": ("L", "l"),      # Short carries long
}

# Process genotype and get mutated sequences
results = converter.process_genotype(genotype)

# Results structure:
# {
#     "MC1R": {
#         "alleles": ["E", "e"],
#         "template_file": "MC1R_template.fasta",
#         "template_sequence": "ATCG...",  # Original
#         "mutated_sequence": "ATCG...",   # After mutations
#         "mutations_applied": [
#             {
#                 "allele": "e",
#                 "description": "Recessive Red",
#                 "type": "SNP",
#                 "position": 542,
#                 "ref": "C",
#                 "mut": "T"
#             }
#         ],
#         "template_length": 954,
#         "mutated_length": 954
#     },
#     # ... more genes
# }
```

### Standalone Testing

```bash
# Extract gene sequences from genomic.fna and mapping.gff
cd Sequence
python read_sequence.py

# Test mutation application
python genotype_to_sequence.py
```

## Data Flow

1. **User selects traits** in `trait_selection.py`
   - Example: "Black carries red", "Sable carries tan-point", etc.

2. **Traits convert to genotype** via `genome_library.py`
   - Example: `{"E": ("E", "e"), "A": ("Ay", "at"), ...}`

3. **Genotype converts to alleles**
   - Example: `["E", "e", "Ay", "at", ...]`

4. **Alleles map to mutations** via `Reference.json`
   - Example: `"e"` → SNP in MC1R gene at specific context

5. **Mutations applied to templates**
   - Load `MC1R_template.fasta`
   - Find context sequence
   - Apply SNP/INS/DEL
   - Return mutated sequence

6. **Output**: Mutated DNA sequences for each gene

## Mutation Application Logic

### SNP (Single Nucleotide Polymorphism)
```python
# Find context in sequence
context_pos = sequence.find("GTGTGCAGCTA")
# Mutation is at middle of context
mutation_pos = context_pos + len(context) // 2
# Replace reference base with mutant base
mutated = sequence[:mutation_pos] + "T" + sequence[mutation_pos + 1:]
```

### DEL (Deletion)
```python
# Find context
context_pos = sequence.find("AAGAAAGAGAC")
# Find deletion sequence near context
deletion_pos = sequence.find("AGA", context_pos)
# Remove deletion sequence
mutated = sequence[:deletion_pos] + sequence[deletion_pos + 3:]
```

### INS (Insertion)
```python
# Find context
context_pos = sequence.find("AAGAAAGAGAC")
# Insert after context
insertion_pos = context_pos + len(context)
mutated = sequence[:insertion_pos] + "BRINDLE_CNV_BLOCK" + sequence[insertion_pos:]
```

## Integration with trait_selection.py

Add this to `trait_selection.py` in the `_go_next()` method:

```python
def _go_next(self):
    # ... existing code ...
    
    # After computing father_final and mother_final
    from Sequence.genotype_to_sequence import GenotypeToSequence
    
    converter = GenotypeToSequence(
        reference_json_path="Sequence/Reference.json",
        sequence_dir="Sequence/extracted_genes"
    )
    
    # Get mutated sequences for both parents
    father_sequences = converter.process_genotype(father_final)
    mother_sequences = converter.process_genotype(mother_final)
    
    # Store on app for later use
    self.app.father_dna_sequences = father_sequences
    self.app.mother_dna_sequences = mother_sequences
    
    # ... continue to next screen ...
```

## File Structure

```
Frontend/
├── Sequence/
│   ├── Reference.json              # Mutation definitions
│   ├── genomic.fna                 # Dog reference genome (2.4GB)
│   ├── mapping.gff                 # Gene annotations (483MB)
│   ├── read_sequence.py            # Gene extractor (auto-runs)
│   ├── genotype_to_sequence.py     # Mutation applier
│   └── extracted_genes/            # Template sequences
│       ├── MC1R_template.fasta
│       ├── ASIP_template.fasta
│       ├── TYRP1_template.fasta
│       ├── FGF5_template.fasta
│       ├── MLPH_template.fasta
│       ├── MITF_template.fasta
│       └── CBD103_template.fasta
├── screens/
│   └── trait_selection.py          # User interface
└── genome_library.py               # Trait definitions
```

## Notes

- The system uses **case-insensitive** context matching to handle variations in DNA sequence formatting
- Multiple mutations can be applied to the same gene (e.g., heterozygous genotypes)
- Reference alleles (type: "REF") don't modify the sequence
- All positions are 0-indexed in the code but can be displayed as 1-indexed for users
